<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Problem Archive — UKMT & Friends</title>

  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{ --bg:#0b0f14; --fg:#e6edf3; --muted:#9aa7b3; --card:#11161d; --line:#1b2430; --accent:#6aa3ff; --bar:#21b09e; }
    html,body{background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .bar{background:var(--bar); color:#031a15; font-weight:800; padding:14px 18px; font-size:20px;}
    .wrap{max-width:1000px; margin:0 auto; padding:12px 16px 40px;}
    .actions{color:var(--muted); font-size:14px; margin:10px 0 18px; display:flex; gap:14px; flex-wrap:wrap}
    .actions button{border:1px solid var(--line); background:#0f1520; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer}
    .actions button:hover{background:#111a2a}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; margin:14px 0}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    input[type="number"],select{background:#0f1520; color:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 8px}
    .problem{padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:#0f1520; margin:12px 0}
    .ptitle{font-weight:800; letter-spacing:.02em}
    .meta{color:var(--muted); font-size:12px}
    .stem{margin-top:8px; line-height:1.55; font-size:17px; white-space:pre-line}
    .options{margin:8px 0; padding-left:20px}
    .options li{margin:2px 0; line-height:1.4}
    .figure{text-align:center;margin:10px 0}
    .figure img{max-width:90%;border-radius:8px;border:1px solid var(--line)}
    hr.sep{border:none; border-top:1px solid var(--line); margin:12px 0 0}
    @media print{ .panel, .actions { display:none !important; } body{background:#fff; color:#000} .problem{border:none; background:#fff} .bar{background:#fff; color:#000; border-bottom:1px solid #000} a{color:#000; text-decoration:none} }
  </style>
</head>
<body>
  <div class="bar" id="titlebar">Problem Archive</div>
  <div class="wrap">
    <div class="actions">
      <button id="btnCopy">Copy problem list</button>
      <button id="btnPrint">Print this page</button>
      <span id="status" class="meta"></span>
    </div>

    <div class="panel">
      <div class="row">
        <label>Contest
          <select id="contest">
            <option value="smc-2024">SMC 2024</option>
            <option value="jmc-2015">JMC 2015</option>
            <option value="jmc-2016">JMC 2016</option>
            <option value="jmc-2017">JMC 2017</option>
            <option value="jmc-2018">JMC 2018</option>
            <option value="jmc-2019">JMC 2019</option>
            <option value="jmc-2020">JMC 2020</option>
            <option value="jmc-2021">JMC 2021</option>
            <option value="jmc-2022">JMC 2022</option>
            <option value="jmc-2023">JMC 2023</option>
            <option value="jmc-2024">JMC 2024</option>
            <option value="jmc-2025">JMC 2025</option>
            <option value="kangaroo-2025">Junior Kangaroo 2025</option>
            <option value="kangaroo-2024">Junior Kangaroo 2024</option>
            <option value="kangaroo-2023">Junior Kangaroo 2023</option>
            <option value="kangaroo-2022">Junior Kangaroo 2022</option>
            <option value="kangaroo-2021">Junior Kangaroo 2021</option>
            <option value="kangaroo-2020">Junior Kangaroo 2020</option>
            <option value="kangaroo-2019">Junior Kangaroo 2019</option>
            <option value="kangaroo-2018">Junior Kangaroo 2018</option>
            <option value="kangaroo-2017">Junior Kangaroo 2017</option>
            <option value="kangaroo-2016">Junior Kangaroo 2016</option>
            <option value="kangaroo-2015">Junior Kangaroo 2015</option>
            <option value="jo-2024">Junior Olympiad 2024</option>
          </select>
        </label>
        <label>Number of problems <input id="count" type="number" min="1" max="30" value="10"></label>
        <label>Difficulty mix
          <select id="mix">
            <option value="balanced">Balanced</option>
            <option value="easy">Easy-leaning</option>
            <option value="hard">Hard-leaning</option>
            <option value="pureRandom">Pure random</option>
          </select>
        </label>
        <button id="btnGenerate">Generate subset</button>
        <button id="btnAll">Show all</button>
      </div>
      <div class="meta" style="margin-top:6px">
        Source: UKMT and related contests (restated with permission). Data loaded from <code>assets/problems/*.json</code>.
      </div>
    </div>

    <div id="list"></div>
  </div>

  <!-- Add these libs in head (KaTeX already present in your site) -->
<!-- Insert this block where you want the controls + list -->
<div class="panel">
  <div class="row">
    <label>Number <input id="outCount" type="number" min="1" max="50" value="12"></label>
    <label>Difficulty mix
      <select id="outMix">
        <option value="balanced">Balanced (E/M/H)</option>
        <option value="easy">Easy-leaning</option>
        <option value="hard">Hard-leaning</option>
        <option value="pureRandom">Pure random</option>
      </select>
    </label>
    <label>Sources (choose) <span id="sourcesSpan"></span></label>
    <button id="buildBtn" class="btn">Generate sheet</button>
    <button id="printBtn" class="btn">Print</button>
  </div>
</div>

<section id="sheetArea" class="panel"></section>

<script>
/* ---------- CONFIG ---------- */
// If you have assets/index.json, the loader will use it. Otherwise list files here:
const FALLBACK_JSON_LIST = [
  '/ProblemSolve/assets/junior-kangaroo-2024.json',
  '/ProblemSolve/assets/jmc-2024.json',
  '/ProblemSolve/assets/smc-2024.json'
  // add more files here
];

const INDEX_JSON_PATH = '/ProblemSolve/assets/index.json'; // optional

/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const el = s => document.createElement(s);

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }
function bucketFromDifficulty(d){ // fallback
  if(!d) return 'M';
  if(['E','e','1'].includes(d)) return 'E';
  if(['M','m','2'].includes(d)) return 'M';
  return 'H';
}

/* ---------- load all JSONs ---------- */
async function loadAllProblems(){
  // try index.json first
  let list;
  try {
    const r = await fetch(INDEX_JSON_PATH, {cache:'no-store'});
    if(r.ok) list = await r.json();
  } catch(e){ /* ignore */ }
  if(!Array.isArray(list)) list = FALLBACK_JSON_LIST;

  const problems = [];
  for(const path of list){
    try {
      const r = await fetch(path, {cache:'no-store'});
      if(!r.ok) { console.warn('skip',path,r.status); continue; }
      const arr = await r.json();
      if(Array.isArray(arr)){
        for(const item of arr){
          // normalize minimal fields
          problems.push({
            id: item.id || `${item.contest||'X'}-${item.year||'NA'}-${item.num||'0'}`,
            contest: item.contest || 'Unknown',
            year: item.year || null,
            num: item.num || null,
            kind: item.kind || 'mc',
            difficulty: bucketFromDifficulty(item.difficulty || item.level || item.diff),
            statement: item.statement || '',
            options: item.options || [],
            answer: item.answer || '',
            images: item.images || [],
            tags: item.tags || [],
            rights: item.rights || ''
          });
        }
      }
    } catch(err){
      console.error('failed load', path, err);
    }
  }
  return problems;
}

/* ---------- UI for source checkboxes ---------- */
function buildSourceControls(problems){
  const sources = [...new Set(problems.map(p=>p.contest))].sort();
  const span = $('#sourcesSpan'); span.innerHTML='';
  for(const s of sources){
    const lbl = el('label');
    const cb = el('input'); cb.type='checkbox'; cb.value=s; cb.checked=true; cb.className='srcchk';
    lbl.appendChild(cb);
    lbl.insertAdjacentText('beforeend', ' ' + s + ' ');
    span.appendChild(lbl);
  }
}

/* ---------- picking algorithm ---------- */
function pickProblems(pool, count, mix='balanced'){
  if(mix === 'pureRandom') return shuffle(pool).slice(0, count);
  // weights by bucket
  const weights = {
    balanced: {E:.4,M:.4,H:.2},
    easy: {E:.6,M:.3,H:.1},
    hard: {E:.15,M:.45,H:.4}
  }[mix] || {E:.4,M:.4,H:.2};

  const by = {E:[],M:[],H:[]};
  pool.forEach(p => by[p.difficulty || 'M'].push(p));
  const want = { E: Math.round(count*weights.E), M: Math.round(count*weights.M) };
  want.H = count - want.E - want.M;
  let out = [];
  out = out.concat(shuffle(by.E).slice(0,want.E));
  out = out.concat(shuffle(by.M).slice(0,want.M));
  out = out.concat(shuffle(by.H).slice(0,want.H));
  if(out.length < count){
    const remaining = pool.filter(p=>!out.includes(p));
    out = out.concat(shuffle(remaining).slice(0, count - out.length));
  }
  // preserve ordering by contest/num or keep shuffled — here we keep the chosen order random:
  return shuffle(out);
}

/* ---------- rendering sheet ---------- */
function renderSheet(problems, opts={title:'Custom problem set'}){
  const host = $('#sheetArea');
  host.innerHTML = '';
  const header = el('div'); header.className='row'; header.style.justifyContent='space-between';
  header.innerHTML = `<div><strong>${opts.title}</strong></div><div class="meta">${new Date().toLocaleString()}</div>`;
  host.appendChild(header);

  problems.forEach((p,i)=>{
    const box = el('div'); box.className='problem'; box.style.marginBottom='16px';
    const head = el('div'); head.innerHTML = `<div class="ptitle">PROBLEM ${i+1} <span class="meta">(${p.contest} ${p.year} #${p.num})</span></div>`;
    const statement = el('div'); statement.className='stem'; statement.innerHTML = p.statement.replace(/\n/g,'<br>');
    // images
    if(p.images && p.images.length){
      for(const src of p.images){
        const im = el('img'); im.src = src; im.style.maxWidth='380px'; im.style.display='block';
        statement.appendChild(im);
      }
    }
    box.appendChild(head);
    box.appendChild(statement);

    // options (if any)
    if(p.options && p.options.length){
      const ul = el('ul'); ul.style.marginTop='8px';
      p.options.forEach((opt,j) => {
        const li = el('li');
        li.innerHTML = `(${String.fromCharCode(65+j)}) ${opt}`;
        ul.appendChild(li);
      });
      box.appendChild(ul);
    }

    // solution hidden
    const sol = el('div'); sol.className='meta solution'; sol.style.display='none';
    sol.innerHTML = `<strong>Answer:</strong> ${p.answer || '—'} ${p.rights?('<div class="meta">'+p.rights+'</div>'):''}`;
    box.appendChild(sol);

    host.appendChild(box);
  });

  // add a toggle for solutions at bottom
  const ctrl = el('div'); ctrl.className='row'; ctrl.style.gap='8px';
  const showBtn = el('button'); showBtn.className='btn'; showBtn.textContent='Toggle solutions';
  showBtn.addEventListener('click', ()=>{
    host.querySelectorAll('.solution').forEach(s=>{
      s.style.display = (s.style.display === 'none') ? 'block' : 'none';
    });
  });
  ctrl.appendChild(showBtn);
  host.appendChild(ctrl);
  // typeset math
  if(window.renderMathInElement) window.renderMathInElement(host, {delimiters:[{left:'$$',right:'$$',display:true},{left:'\\(',right:'\\)',display:false},{left:'$',right:'$',display:false}]});
}

/* ---------- wire up ---------- */
let ALL_PROBLEMS = [];

(async function init(){
  ALL_PROBLEMS = await loadAllProblems();
  if(!ALL_PROBLEMS.length){
    $('#sheetArea').textContent = 'No problems loaded — check assets/index.json or the file list in FALLBACK_JSON_LIST.';
    return;
  }
  buildSourceControls(ALL_PROBLEMS);

  $('#buildBtn').addEventListener('click', ()=>{
    const n = Math.max(1, Math.min(50, +$('#outCount').value||12));
    const mix = $('#outMix').value;
    const srcChecked = [...document.querySelectorAll('.srcchk:checked')].map(i=>i.value);
    const pool = ALL_PROBLEMS.filter(p => srcChecked.includes(p.contest));
    const chosen = pickProblems(pool, n, mix);
    renderSheet(chosen, {title:`Random set (${n}) — ${mix}`});
  });

  $('#printBtn').addEventListener('click', ()=>window.print());
})();
</script>

<script>
const $ = (s)=>document.querySelector(s);
const statusEl = $('#status');

function renderMathIn(el){
  if (!window.renderMathInElement) return;
  window.renderMathInElement(el, {
    delimiters: [
      {left:"$$", right:"$$", display:true},
      {left:"\\(", right:"\\)", display:false},
      {left:"$", right:"$", display:false}
    ]
  });
}
function diffBucket(num){ const d=num/25; return d<.34?'E':d<.67?'M':'H'; }
function choose(list,k){ const a=list.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a.slice(0,Math.min(k,a.length)); }

/* ---- Load JSON for contest ---- */
async function loadContest(contestFile){
  statusEl.textContent = `Loading ${contestFile}…`;
  try {
    const r = await fetch(`/ProblemSolve/assets/${contestFile}.json`, {cache:'no-store'});
    if (!r.ok) throw new Error("HTTP " + r.status);
    const arr = await r.json();
    const probs = arr.map(b => ({
      id: `${b.contest}-${b.year}-Q${b.num}`,
      source: "UKMT",
      ...b,
      rights: "© UKMT, used with permission.",
      difficulty: diffBucket(b.num),
      options: b.options || []
    }));
    window._currentProblems = probs;
    statusEl.textContent = `Loaded ✓ ${probs.length} problems from ${contestFile}`;
    return probs;
  } catch(e){
    console.error(e);
    statusEl.textContent = `Load failed for ${contestFile}`;
    return [];
  }
}

/* ---- Render ---- */
function renderList(problems){
  const list = $('#list');
  list.innerHTML = problems.map((p,i)=>`
    <div class="problem">
      <div class="ptitle">PROBLEM ${i+1} <span class="meta">(${p.year} ${p.contest} #${p.num})</span></div>
      <div class="stem">${p.statement.replace(/\n/g,'<br>')}</div>
      ${p.image ? `<div class="figure"><img src="${p.image}" alt="Problem ${p.num}" /></div>` : ''}
      <ul class="options">
        ${(p.options && p.options.length ? p.options.map((opt,j)=>`<li>(${String.fromCharCode(65+j)}) ${opt}</li>`).join('') : '<li><em>No options</em></li>')}
      </ul>
      <div class="meta" style="margin-top:8px">${p.rights||''}</div>
      <hr class="sep">
    </div>
  `).join('');
  renderMathIn(list);
  $('#titlebar').textContent = `Problem Archive (${problems.length} problems)`;
}

function toPlainText(problems){
  return problems.map((p,i)=>`PROBLEM ${i+1} (${p.year} ${p.contest} #${p.num})\n${p.statement}\nOptions: ${p.options.join(" | ")}`).join("\n\n---\n\n");
}

function pickSubset(all,count,mix){
  if(mix==='pureRandom') return choose(all,count).sort((a,b)=>a.num-b.num);
  const weights={balanced:{E:.4,M:.4,H:.2},easy:{E:.6,M:.3,H:.1},hard:{E:.15,M:.45,H:.4}}[mix]||{E:.4,M:.4,H:.2};
  const by={E:[],M:[],H:[]}; all.forEach(p=>by[p.difficulty||diffBucket(p.num)].push(p));
  const want={E:Math.round(count*weights.E), M:Math.round(count*weights.M)}; want.H=count-want.E-want.M;
  let out=[].concat(choose(by.E,want.E), choose(by.M,want.M), choose(by.H,want.H));
  if(out.length<count) out=out.concat(choose(all.filter(p=>!out.includes(p)), count-out.length));
  return out.sort((a,b)=>a.num-b.num);
}

/* ---- Init ---- */
(async function init(){
  const contestFile = $('#contest').value;
  const problems = await loadContest(contestFile);
  renderList(problems);

  $('#contest').addEventListener('change', async (e)=>{
    const probs = await loadContest(e.target.value);
    renderList(probs);
  });

  $('#btnCopy').addEventListener('click', async ()=>{ 
    try{ await navigator.clipboard.writeText(toPlainText(window._currentProblems||[])); statusEl.textContent="Copied ✓"; }
    catch(e){ statusEl.textContent="Copy failed: "+e.message; }
  });
  $('#btnPrint').addEventListener('click', ()=>window.print());
  $('#btnAll').addEventListener('click', ()=>renderList(window._currentProblems||[]));
  $('#btnGenerate').addEventListener('click', ()=>{ 
    const n=Math.max(1,Math.min(30,+$('#count').value||30)); 
    const mix=$('#mix').value; 
    renderList(pickSubset(window._currentProblems||[], n, mix)); 
  });
})();
</script>
</body>
</html>
