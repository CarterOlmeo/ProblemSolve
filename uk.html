<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Problem Archive â€” UKMT & Friends</title>

  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>

  <style>
    :root{ --bg:#0b0f14; --fg:#e6edf3; --muted:#9aa7b3; --card:#11161d; --line:#1b2430; --accent:#6aa3ff; --bar:#21b09e; }
    html,body{background:var(--bg);color:var(--fg);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .bar{background:var(--bar); color:#031a15; font-weight:800; padding:14px 18px; font-size:20px;}
    .wrap{max-width:1000px; margin:0 auto; padding:12px 16px 40px;}
    .actions{color:var(--muted); font-size:14px; margin:10px 0 18px; display:flex; gap:14px; flex-wrap:wrap}
    .actions button{border:1px solid var(--line); background:#0f1520; color:#fff; padding:8px 10px; border-radius:10px; cursor:pointer}
    .actions button:hover{background:#111a2a}
    .panel{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; margin:14px 0}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    input[type="number"],select{background:#0f1520; color:#fff; border:1px solid var(--line); border-radius:10px; padding:6px 8px}
    .problem{padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:#0f1520; margin:12px 0}
    .ptitle{font-weight:800; letter-spacing:.02em}
    .meta{color:var(--muted); font-size:12px}
    .stem{margin-top:8px; line-height:1.55; font-size:17px; white-space:pre-line}
    .options{margin:8px 0; padding-left:20px}
    .options li{margin:2px 0; line-height:1.4}
    .figure{text-align:center;margin:10px 0}
    .figure img{max-width:90%;border-radius:8px;border:1px solid var(--line)}
    .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    hr.sep{border:none; border-top:1px solid var(--line); margin:12px 0 0}
    .btn { background:#0f1520; color:#fff; border:1px solid var(--line); padding:6px 8px; border-radius:8px; cursor:pointer }
    .btn:hover { background:#111a2a }
    @media print{ .panel, .actions, .btn { display:none !important; } body{background:#fff; color:#000} .problem{border:none; background:#fff} .bar{background:#fff; color:#000; border-bottom:1px solid #000} a{color:#000; text-decoration:none} }
  </style>
</head>
<body>
  <div class="bar" id="titlebar">Problem Archive</div>
  <div class="wrap">
    <div class="actions">
      <button id="btnCopy" class="btn">Copy problem list</button>
      <button id="btnPrint" class="btn">Print this page</button>
      <span id="status" class="meta"></span>
    </div>

    <div class="panel">
      <div class="row">
        <label>
          Contest
          <select id="contestSelect">
            <option value="">(choose contest)</option>
          </select>
        </label>

        <label>Number <input id="count" type="number" min="1" max="50" value="10"></label>

        <label>Difficulty mix
          <select id="mix">
            <option value="balanced">Balanced</option>
            <option value="easy">Easy-leaning</option>
            <option value="hard">Hard-leaning</option>
            <option value="pureRandom">Pure random</option>
          </select>
        </label>

        <button id="btnGenerate" class="btn">Generate subset</button>
        <button id="btnAll" class="btn">Show all</button>
      </div>
      <div class="meta" style="margin-top:6px">
        Source: UKMT & friends (restated with permission). Data loaded from <code>assets/*.json</code>. Add JSON files to <code>/ProblemSolve/assets/</code> and edit SOURCES in the script below.
      </div>
    </div>

    <!-- sheet builder panel -->
    <div class="panel">
      <div class="row controls">
        <label>Out count <input id="outCount" type="number" min="1" max="50" value="12"></label>
        <label>Out mix
          <select id="outMix">
            <option value="balanced">Balanced (E/M/H)</option>
            <option value="easy">Easy-leaning</option>
            <option value="hard">Hard-leaning</option>
            <option value="pureRandom">Pure random</option>
          </select>
        </label>

        <div id="sourcesControls" style="display:flex;gap:8px;align-items:center"></div>

        <button id="buildBtn" class="btn">Generate sheet</button>
        <button id="printSheetBtn" class="btn">Print sheet</button>
      </div>
    </div>

    <div id="list"></div>

    <section id="sheetArea" class="panel"></section>
  </div>

<script>
/* ---------- Configuration: list your JSONs here ---------- */
/* Put your files in /ProblemSolve/assets/ and name them in SOURCES.
   Each JSON should be an array of objects:
   { "contest": "JMC", "year": 2024, "num": 1, "statement": "...", "options": [...], "answer":"", "images": ["assets/img1.png"], "difficulty":"E" }
*/
const SOURCES = [
  { id: 'smc-2024', path: '/ProblemSolve/assets/smc-2024.json' },
  { id: 'jmc-2024', path: '/ProblemSolve/assets/jmc-2024.json' },
  { id: 'junior-kangaroo-2024', path: '/ProblemSolve/assets/junior-kangaroo-2024.json' }
  // add additional JSON files here
];

/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const statusEl = $('#status');

function logStatus(msg){ if(statusEl) statusEl.textContent = msg; else console.log(msg); }

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
function choose(list,k){ return shuffle(list.slice()).slice(0, Math.min(k, list.length)); }

/* extract options if statement contains (A) ... (B) ... ... */
const OPT_RE = /(.*?)\s*\(A\)\s*([\s\S]*?)\s*\(B\)\s*([\s\S]*?)\s*\(C\)\s*([\s\S]*?)\s*\(D\)\s*([\s\S]*?)\s*\(E\)\s*([\s\S]*?)(?:$|\n)/m;

/* normalize difficulty marker */
function normalizeDifficulty(d){
  if(!d) return null;
  const s = String(d).trim().toUpperCase();
  if(s.startsWith('E')) return 'E';
  if(s.startsWith('M')) return 'M';
  if(s.startsWith('H')) return 'H';
  if(['1','EASY'].includes(s)) return 'E';
  if(['2','MED','MEDIUM'].includes(s)) return 'M';
  if(['3','HARD'].includes(s)) return 'H';
  return null;
}

/* infer difficulty heuristics (tweak for your taste) */
function inferDifficulty(problem){
  if(problem.difficulty) return normalizeDifficulty(problem.difficulty);
  const c = (problem.contest||'').toUpperCase();
  const n = Number(problem.num) || 0;
  if(c.includes('JMC')){
    if(n <= 5) return 'H';
    if(n <= 15) return 'M';
    return 'E';
  }
  if(c.includes('SMC')){
    if(n <= 8) return 'E';
    if(n <= 17) return 'M';
    return 'H';
  }
  if(c.includes('KANG') || c.includes('JUNIOR')){
    if(n <= 10) return 'E';
    if(n <= 20) return 'M';
    return 'H';
  }
  return 'M';
}

/* sanitize a raw JSON problem entry */
function sanitize(raw, defaultContest){
  const p = Object.assign({}, raw);
  p.contest = p.contest || defaultContest || 'Unknown';
  p.year = p.year || null;
  p.num = (raw.num === 0 || raw.num) ? raw.num : null;
  p.id = p.id || `${p.contest}-${p.year || 'NA'}-Q${p.num || 'X'}`;
  p.options = Array.isArray(raw.options) ? raw.options.slice() : [];
  p.images = Array.isArray(raw.images) ? raw.images.slice() : (raw.image ? [raw.image] : []);
  p.answer = raw.answer || raw.answer === 0 ? String(raw.answer) : '';
  p.rights = raw.rights || '';
  p.statement = (typeof raw.statement === 'string') ? raw.statement.replace(/\r/g,'').trim() : (raw.statement ? String(raw.statement) : '');
  // try to extract options if none present
  if((!p.options || p.options.length === 0) && typeof p.statement === 'string'){
    const m = OPT_RE.exec(p.statement);
    if(m){
      const stem = (m[1] || '').trim();
      p.statement = stem || p.statement;
      p.options = [m[2].trim(), m[3].trim(), m[4].trim(), m[5].trim(), m[6].trim()];
    }
  }
  p.difficulty = normalizeDifficulty(raw.difficulty) || inferDifficulty(p);
  return p;
}

/* ---------- Load all JSON files (SOURCES) ---------- */
let ALL_PROBLEMS = [];

async function loadSources(){
  logStatus('Loading problem JSONs...');
  const loads = SOURCES.map(async s=>{
    try{
      const r = await fetch(s.path, { cache: 'no-store' });
      if(!r.ok){ console.warn('skip', s.path, r.status); return []; }
      const arr = await r.json();
      if(!Array.isArray(arr)) { console.warn('not array', s.path); return []; }
      const san = arr.map(item => sanitize(item, s.id));
      return san;
    }catch(err){
      console.warn('failed load', s.path, err);
      return [];
    }
  });
  const results = await Promise.all(loads);
  ALL_PROBLEMS = results.flat();
  logStatus(`Loaded ${ALL_PROBLEMS.length} problems from ${SOURCES.length} JSONs.`);
  return ALL_PROBLEMS;
}

/* ---------- Build source checkboxes (from contests found) ---------- */
function buildSourcesUI(){
  const uniqContests = [...new Set(ALL_PROBLEMS.map(p => p.contest || 'Unknown'))].sort();
  const contSelect = $('#contestSelect');
  contSelect.innerHTML = '<option value="">(choose contest)</option>';
  uniqContests.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c;
    contSelect.appendChild(opt);
  });

  const sc = $('#sourcesControls');
  sc.innerHTML = '<strong>Sources:</strong> ';
  uniqContests.forEach(c => {
    const label = document.createElement('label'); label.style.marginRight='8px';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.className='srcchk'; cb.value = c; cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(' ' + c));
    sc.appendChild(label);
  });
}

/* ---------- Pool & selection ---------- */
function selectedSources(){
  return $$('.srcchk:checked').map(ch => ch.value);
}

function poolForSelectedSources(){
  const sel = selectedSources();
  if(!sel || sel.length === 0) return ALL_PROBLEMS.slice();
  return ALL_PROBLEMS.filter(p => sel.includes(p.contest));
}

function pickProblems(pool, count, mix){
  if(!pool || pool.length === 0) return [];
  if(mix === 'pureRandom') return choose(pool, count);
  const weights = {
    balanced: {E:.4, M:.4, H:.2},
    easy: {E:.6, M:.3, H:.1},
    hard: {E:.15, M:.45, H:.4}
  }[mix] || {E:.4,M:.4,H:.2};
  const buckets = {E:[], M:[], H:[]};
  pool.forEach(p => {
    const d = inferDifficulty(p);
    buckets[d] = buckets[d] || [];
    buckets[d].push(p);
  });
  const wantE = Math.round(count * weights.E);
  const wantM = Math.round(count * weights.M);
  const wantH = count - wantE - wantM;
  let out = [].concat(choose(buckets.E, wantE), choose(buckets.M, wantM), choose(buckets.H, wantH));
  if(out.length < count){
    const remaining = pool.filter(p => !out.includes(p));
    out = out.concat(choose(remaining, count - out.length));
  }
  return shuffle(out);
}

/* ---------- Rendering functions ---------- */
function renderList(problems){
  const list = $('#list');
  if(!Array.isArray(problems)) problems = [];
  list.innerHTML = problems.map((p,i) => {
    const head = `<div class="ptitle">PROBLEM ${i+1} <span class="meta">(${p.year||''} ${p.contest||''} #${p.num||''})</span></div>`;
    const stmt = `<div class="stem">${(p.statement||'[no statement]').replace(/\n/g,'<br>')}</div>`;
    const imgs = (p.images && p.images.length) ? p.images.map(src=>`<div class="figure"><img src="${src}" alt=""></div>`).join('') : '';
    const opts = (p.options && p.options.length) ? `<ul class="options">${p.options.map((o,j)=>`<li>(${String.fromCharCode(65+j)}) ${o}</li>`).join('')}</ul>` : '<div class="meta"><em>No options</em></div>';
    const rights = p.rights ? `<div class="meta">${p.rights}</div>` : '';
    return `<div class="problem">${head}${stmt}${imgs}${opts}${rights}<hr class="sep"></div>`;
  }).join('');
  if(window.renderMathInElement) {
    window.renderMathInElement(list, {
      delimiters:[{left:'$$',right:'$$',display:true},{left:'\\(',right:'\\)',display:false},{left:'$',right:'$',display:false}]
    });
  }
  $('#titlebar').textContent = `Problem Archive (${problems.length} problems)`;
}

function toPlainText(problems){
  return problems.map((p,i)=>`PROBLEM ${i+1} (${p.year||''} ${p.contest||''} #${p.num||''})\n${p.statement}\nOptions: ${p.options && p.options.length ? p.options.join(' | ') : 'â€”'}`).join("\n\n---\n\n");
}

/* ---------- Sheet builder ---------- */
function renderSheet(probs, opts={title:'Custom set'}){
  const host = $('#sheetArea');
  host.innerHTML = '';
  const header = document.createElement('div'); header.className = 'row'; header.style.justifyContent='space-between';
  header.innerHTML = `<div><strong>${opts.title}</strong></div><div class="meta">${new Date().toLocaleString()}</div>`;
  host.appendChild(header);

  probs.forEach((p,i) => {
    const box = document.createElement('div'); box.className = 'problem';
    const head = document.createElement('div'); head.innerHTML = `<div class="ptitle">PROBLEM ${i+1} <span class="meta">(${p.contest} ${p.year||''} #${p.num||''})</span></div>`;
    const statement = document.createElement('div'); statement.className = 'stem'; statement.innerHTML = (p.statement||'').replace(/\n/g,'<br>');
    box.appendChild(head);
    box.appendChild(statement);
    if(p.images && p.images.length){
      p.images.forEach(src => {
        const fig = document.createElement('div'); fig.className='figure';
        const img = document.createElement('img'); img.src = src; img.alt = ''; fig.appendChild(img);
        box.appendChild(fig);
      });
    }
    if(p.options && p.options.length){
      const ul = document.createElement('ul'); ul.className = 'options';
      p.options.forEach((o,j) => {
        const li = document.createElement('li');
        li.innerHTML = `(${String.fromCharCode(65+j)}) ${o}`;
        ul.appendChild(li);
      });
      box.appendChild(ul);
    }
    const sol = document.createElement('div'); sol.className = 'meta solution'; sol.style.display='none';
    sol.innerHTML = `<strong>Answer:</strong> ${p.answer || 'â€”'} ${p.rights ? `<div class="meta">${p.rights}</div>` : ''}`;
    box.appendChild(sol);
    host.appendChild(box);
  });

  const ctrl = document.createElement('div'); ctrl.className = 'row';
  const toggle = document.createElement('button'); toggle.className='btn'; toggle.textContent='Toggle solutions';
  toggle.addEventListener('click', () => {
    host.querySelectorAll('.solution').forEach(s => {
      s.style.display = s.style.display === 'none' ? 'block' : 'none';
    });
  });
  ctrl.appendChild(toggle);
  host.appendChild(ctrl);

  if(window.renderMathInElement){
    window.renderMathInElement(host, {
      delimiters:[{left:'$$',right:'$$',display:true},{left:'\\(',right:'\\)',display:false},{left:'$',right:'$',display:false}]
    });
  }
}

/* ---------- Wire up controls ---------- */
(async function init(){
  await loadSources();
  buildSourcesUI();

  // initial render: show everything
  renderList(ALL_PROBLEMS);

  // contest dropdown change: show that contest
  $('#contestSelect').addEventListener('change', (e)=>{
    const v = e.target.value;
    if(!v) { renderList(ALL_PROBLEMS); return; }
    const filtered = ALL_PROBLEMS.filter(p => p.contest === v);
    renderList(filtered);
  });

  // btnAll
  $('#btnAll').addEventListener('click', ()=> renderList(ALL_PROBLEMS));

  // generate subset from currently selected sources
  $('#btnGenerate').addEventListener('click', ()=>{
    const n = Math.max(1, Math.min(50, +$('#count').value || 10));
    const mix = $('#mix').value || 'balanced';
    const pool = poolForSelectedSources();
    const chosen = pickProblems(pool, n, mix);
    renderList(chosen);
  });

  // copy list
  $('#btnCopy').addEventListener('click', async ()=>{
    try{
      const sel = poolForSelectedSources();
      await navigator.clipboard.writeText(toPlainText(sel));
      logStatus('Copied list to clipboard âœ“');
    }catch(e){
      logStatus('Copy failed: ' + (e && e.message));
    }
  });

  // print main list
  $('#btnPrint').addEventListener('click', ()=> window.print());

  // build sheet button
  $('#buildBtn').addEventListener('click', ()=>{
    const n = Math.max(1, Math.min(50, +$('#outCount').value || 12));
    const mix = $('#outMix').value || 'balanced';
    const pool = poolForSelectedSources();
    const chosen = pickProblems(pool, n, mix);
    renderSheet(chosen, {title:`Random set (${n}) â€” ${mix}`});
    window.scrollTo({ top: document.getElementById('sheetArea').offsetTop, behavior:'smooth' });
  });

  // print sheet
  $('#printSheetBtn').addEventListener('click', ()=> window.print());

})();
</script>
</body>
</html>
