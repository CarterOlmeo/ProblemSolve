<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Problem Set — SMC 2024</title>

  <!-- KaTeX for math rendering -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn<script>
/* surface JS errors in the status line */
window.addEventListener('error', e => {
  const s = document.getElementById('status');
  if (s) s.textContent = 'JS error: ' + e.message;
});

const $ = (s)=>document.querySelector(s);
const statusEl = $('#status');

function renderMathIn(el){
  if (!window.renderMathInElement) return;
  window.renderMathInElement(el, {
    delimiters: [
      {left:"$$", right:"$$", display:true},
      {left:"\\(", right:"\\)", display:false},
      {left:"$", right:"$", display:false}
    ]
  });
}
function diffBucket(num){ const d=num/25; return d<.34?'E':d<.67?'M':'H'; }
function choose(list,k){ const a=list.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a.slice(0,Math.min(k,a.length)); }

/* -------- PDF extractor (blob-aware) -------- */
async function extractSMC2024(url){
  async function loadPdf(u){
    try {
      return await pdfjsLib.getDocument({ url: u, disableRange: true }).promise;
    } catch (e) {
      const resp = await fetch(u);
      if (!resp.ok) throw new Error(`HTTP ${resp.status} for ${u}`);
      const buf = await resp.arrayBuffer();
      return await pdfjsLib.getDocument({ data: buf }).promise;
    }
  }

  const pdf = await loadPdf(url);
  const lines = [];

  for (let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const items = content.items.map(it=>({s:it.str,x:it.transform[4],y:it.transform[5]}))
      .sort((a,b)=> (a.y===b.y ? a.x-b.x : b.y-a.y));
    let row=[], prevY=null;
    const flush=()=>{ if(row.length){ const txt=row.map(t=>t.s).join(' ').replace(/\s+/g,' ').trim(); if(txt) lines.push(txt); row=[]; } };
    for(const it of items){ if(prevY===null) prevY=it.y; if(Math.abs(it.y-prevY)>2){ flush(); prevY=it.y; } row.push(it); }
    flush(); lines.push('');
  }

  let text = lines.join('\n').replace(/(\d)\s+(?=\d)/g,'$1');

  const re = /^([1-9]|1\d|2[0-5])\.\s([\s\S]*?)(?=^\s*(?:[1-9]|1\d|2[0-5])\.\s|$)/gm;
  const blocks=[]; let m;
  while((m=re.exec(text))!==null){
    const n=parseInt(m[1],10);
    let body=m[2].replace(/[ \t]+/g,' ').trim();
    const opt=/\(A\)\s*([\s\S]*?)\s*\(B\)\s*([\s\S]*?)\s*\(C\)\s*([\s\S]*?)\s*\(D\)\s*([\s\S]*?)\s*\(E\)\s*([\s\S]*?)$/;
    let statement=body;
    const om=opt.exec(body);
    if(om){
      const stem=body.slice(0,om.index).trim();
      const [A,B,C,D,E]=om.slice(1).map(t=>t.replace(/\s+/g,' ').trim());
      statement=`${stem}\n(A) ${A}\n(B) ${B}\n(C) ${C}\n(D) ${D}\n(E) ${E}`;
    }
    if(!/\(A\)[\s\S]*\(B\)[\s\S]*\(C\)[\s\S]*\(D\)[\s\S]*\(E\)/.test(statement)) continue;
    blocks.push({num:n, statement});
  }

  return blocks.sort((a,b)=>a.num-b.num).map(b=>({
    id:`SMC-2024-Q${b.num}`, source:"UKMT", contest:"SMC", year:2024, num:b.num, kind:"mc",
    rights:"© UKMT, used with permission.", difficulty:diffBucket(b.num), statement:b.statement
  }));
}

/* -------- sources (single definition each!) -------- */
const UKMT_SMC_2024 = "https://ukmt.org.uk/wp-content/uploads/2024/10/SMC-2024-Paper.pdf";
const LOCAL_ABS = "/ProblemSolve/assets/SMC-2024-Paper.pdf";
const LOCAL_REL = "assets/SMC-2024-Paper.pdf";

/* -------- loader (try local first, then UKMT) -------- */
async function loadSMC2024(){
  statusEl.textContent = "Loading SMC 2024…";
  const tries = [LOCAL_ABS, LOCAL_REL, UKMT_SMC_2024];
  for (const u of tries){
    try{
      const probs = await extractSMC2024(u);
      if (probs && probs.length){
        window._smc2024 = probs;
        statusEl.textContent = `Loaded SMC 2024 ✓ (${u.includes('http') ? 'UKMT' : 'local'})`;
        return probs;
      }
    }catch(e){
      console.warn('load failed for', u, e);
      statusEl.textContent = `Tried ${u.includes('http')?'UKMT':'local'}…`;
    }
  }
  statusEl.textContent = "SMC 2024 load failed — check the PDF path/casing.";
  return [
    {id:"SMC-2024-Q1",source:"UKMT",contest:"SMC",year:2024,num:1,kind:"mc",
     rights:"© UKMT, used with permission.",difficulty:"E",
     statement:"(Seed) If $a+b=10$ and $ab=21$, find $a^2+b^2$. (A) 42 (B) 58 (C) 62 (D) 70 (E) 100"}
  ];
}

/* -------- rendering & controls -------- */
function renderList(problems){
  const list = $('#list');
  list.innerHTML = problems.map((p,i)=>`
    <div class="problem">
      <div class="ptitle">PROBLEM ${i+1} <span class="meta">(${p.year} ${p.contest} #${p.num})</span></div>
      <div class="stem">${p.statement.replace(/\n/g,'<br>')}</div>
      <div class="meta" style="margin-top:8px">${p.rights||''}</div>
      <hr class="sep">
    </div>
  `).join('');
  renderMathIn(list);
  // ❗️fixed: remove the escape so the number is evaluated
  $('#titlebar').textContent = `Problem Set — SMC 2024 (${problems.length} problems)`;
}

function toPlainText(problems){
  return problems.map((p,i)=>`PROBLEM ${i+1} (${p.year} ${p.contest} #${p.num})\n${p.statement}`).join("\n\n---\n\n");
}

function pickSubset(all,count,mix){
  if(mix==='pureRandom') return choose(all,count).sort((a,b)=>a.num-b.num);
  const weights={balanced:{E:.4,M:.4,H:.2},easy:{E:.6,M:.3,H:.1},hard:{E:.15,M:.45,H:.4}}[mix]||{E:.4,M:.4,H:.2};
  const by={E:[],M:[],H:[]}; all.forEach(p=>by[p.difficulty||diffBucket(p.num)].push(p));
  const want={E:Math.round(count*weights.E), M:Math.round(count*weights.M)}; want.H=count-want.E-want.M;
  let out=[].concat(choose(by.E,want.E), choose(by.M,want.M), choose(by.H,want.H));
  if(out.length<count) out=out.concat(choose(all.filter(p=>!out.includes(p)), count-out.length));
  return out.sort((a,b)=>a.num-b.num);
}

(async function init(){
  const problems = await loadSMC2024();
  renderList(problems);

  $('#btnCopy').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(toPlainText(window._smc2024||problems)); statusEl.textContent="Copied list to clipboard ✓"; }
    catch(e){ statusEl.textContent="Copy failed: "+e.message; }
  });
  $('#btnPrint').addEventListener('click', ()=>window.print());
  $('#btnAll').addEventListener('click', ()=>renderList(window._smc2024||problems));
  $('#btnGenerate').addEventListener('click', ()=>{
    const n=Math.max(1,Math.min(25,+$('#count').value||25));
    const mix=$('#mix').value;
    renderList(pickSubset(window._smc2024||problems, n, mix));
  });
})();
<script>
/* surface JS errors in the status line */
window.addEventListener('error', e => {
  const s = document.getElementById('status');
  if (s) s.textContent = 'JS error: ' + e.message;
});

const $ = (s)=>document.querySelector(s);
const statusEl = $('#status');

function renderMathIn(el){
  if (!window.renderMathInElement) return;
  window.renderMathInElement(el, {
    delimiters: [
      {left:"$$", right:"$$", display:true},
      {left:"\\(", right:"\\)", display:false},
      {left:"$", right:"$", display:false}
    ]
  });
}
function diffBucket(num){ const d=num/25; return d<.34?'E':d<.67?'M':'H'; }
function choose(list,k){ const a=list.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a.slice(0,Math.min(k,a.length)); }

/* -------- PDF extractor (blob-aware) -------- */
async function extractSMC2024(url){
  async function loadPdf(u){
    try {
      return await pdfjsLib.getDocument({ url: u, disableRange: true }).promise;
    } catch (e) {
      const resp = await fetch(u);
      if (!resp.ok) throw new Error(`HTTP ${resp.status} for ${u}`);
      const buf = await resp.arrayBuffer();
      return await pdfjsLib.getDocument({ data: buf }).promise;
    }
  }

  const pdf = await loadPdf(url);
  const lines = [];

  for (let p=1; p<=pdf.numPages; p++){
    const page = await pdf.getPage(p);
    const content = await page.getTextContent();
    const items = content.items.map(it=>({s:it.str,x:it.transform[4],y:it.transform[5]}))
      .sort((a,b)=> (a.y===b.y ? a.x-b.x : b.y-a.y));
    let row=[], prevY=null;
    const flush=()=>{ if(row.length){ const txt=row.map(t=>t.s).join(' ').replace(/\s+/g,' ').trim(); if(txt) lines.push(txt); row=[]; } };
    for(const it of items){ if(prevY===null) prevY=it.y; if(Math.abs(it.y-prevY)>2){ flush(); prevY=it.y; } row.push(it); }
    flush(); lines.push('');
  }

  let text = lines.join('\n').replace(/(\d)\s+(?=\d)/g,'$1');

  const re = /^([1-9]|1\d|2[0-5])\.\s([\s\S]*?)(?=^\s*(?:[1-9]|1\d|2[0-5])\.\s|$)/gm;
  const blocks=[]; let m;
  while((m=re.exec(text))!==null){
    const n=parseInt(m[1],10);
    let body=m[2].replace(/[ \t]+/g,' ').trim();
    const opt=/\(A\)\s*([\s\S]*?)\s*\(B\)\s*([\s\S]*?)\s*\(C\)\s*([\s\S]*?)\s*\(D\)\s*([\s\S]*?)\s*\(E\)\s*([\s\S]*?)$/;
    let statement=body;
    const om=opt.exec(body);
    if(om){
      const stem=body.slice(0,om.index).trim();
      const [A,B,C,D,E]=om.slice(1).map(t=>t.replace(/\s+/g,' ').trim());
      statement=`${stem}\n(A) ${A}\n(B) ${B}\n(C) ${C}\n(D) ${D}\n(E) ${E}`;
    }
    if(!/\(A\)[\s\S]*\(B\)[\s\S]*\(C\)[\s\S]*\(D\)[\s\S]*\(E\)/.test(statement)) continue;
    blocks.push({num:n, statement});
  }

  return blocks.sort((a,b)=>a.num-b.num).map(b=>({
    id:`SMC-2024-Q${b.num}`, source:"UKMT", contest:"SMC", year:2024, num:b.num, kind:"mc",
    rights:"© UKMT, used with permission.", difficulty:diffBucket(b.num), statement:b.statement
  }));
}

/* -------- sources (single definition each!) -------- */
const UKMT_SMC_2024 = "https://ukmt.org.uk/wp-content/uploads/2024/10/SMC-2024-Paper.pdf";
const LOCAL_ABS = "/ProblemSolve/assets/SMC-2024-Paper.pdf";
const LOCAL_REL = "assets/SMC-2024-Paper.pdf";

/* -------- loader (try local first, then UKMT) -------- */
async function loadSMC2024(){
  statusEl.textContent = "Loading SMC 2024…";
  const tries = [LOCAL_ABS, LOCAL_REL, UKMT_SMC_2024];
  for (const u of tries){
    try{
      const probs = await extractSMC2024(u);
      if (probs && probs.length){
        window._smc2024 = probs;
        statusEl.textContent = `Loaded SMC 2024 ✓ (${u.includes('http') ? 'UKMT' : 'local'})`;
        return probs;
      }
    }catch(e){
      console.warn('load failed for', u, e);
      statusEl.textContent = `Tried ${u.includes('http')?'UKMT':'local'}…`;
    }
  }
  statusEl.textContent = "SMC 2024 load failed — check the PDF path/casing.";
  return [
    {id:"SMC-2024-Q1",source:"UKMT",contest:"SMC",year:2024,num:1,kind:"mc",
     rights:"© UKMT, used with permission.",difficulty:"E",
     statement:"(Seed) If $a+b=10$ and $ab=21$, find $a^2+b^2$. (A) 42 (B) 58 (C) 62 (D) 70 (E) 100"}
  ];
}

/* -------- rendering & controls -------- */
function renderList(problems){
  const list = $('#list');
  list.innerHTML = problems.map((p,i)=>`
    <div class="problem">
      <div class="ptitle">PROBLEM ${i+1} <span class="meta">(${p.year} ${p.contest} #${p.num})</span></div>
      <div class="stem">${p.statement.replace(/\n/g,'<br>')}</div>
      <div class="meta" style="margin-top:8px">${p.rights||''}</div>
      <hr class="sep">
    </div>
  `).join('');
  renderMathIn(list);
  // ❗️fixed: remove the escape so the number is evaluated
  $('#titlebar').textContent = `Problem Set — SMC 2024 (${problems.length} problems)`;
}

function toPlainText(problems){
  return problems.map((p,i)=>`PROBLEM ${i+1} (${p.year} ${p.contest} #${p.num})\n${p.statement}`).join("\n\n---\n\n");
}

function pickSubset(all,count,mix){
  if(mix==='pureRandom') return choose(all,count).sort((a,b)=>a.num-b.num);
  const weights={balanced:{E:.4,M:.4,H:.2},easy:{E:.6,M:.3,H:.1},hard:{E:.15,M:.45,H:.4}}[mix]||{E:.4,M:.4,H:.2};
  const by={E:[],M:[],H:[]}; all.forEach(p=>by[p.difficulty||diffBucket(p.num)].push(p));
  const want={E:Math.round(count*weights.E), M:Math.round(count*weights.M)}; want.H=count-want.E-want.M;
  let out=[].concat(choose(by.E,want.E), choose(by.M,want.M), choose(by.H,want.H));
  if(out.length<count) out=out.concat(choose(all.filter(p=>!out.includes(p)), count-out.length));
  return out.sort((a,b)=>a.num-b.num);
}

(async function init(){
  const problems = await loadSMC2024();
  renderList(problems);

  $('#btnCopy').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(toPlainText(window._smc2024||problems)); statusEl.textContent="Copied list to clipboard ✓"; }
    catch(e){ statusEl.textContent="Copy failed: "+e.message; }
  });
  $('#btnPrint').addEventListener('click', ()=>window.print());
  $('#btnAll').addEventListener('click', ()=>renderList(window._smc2024||problems));
  $('#btnGenerate').addEventListener('click', ()=>{
    const n=Math.max(1,Math.min(25,+$('#count').value||25));
    const mix=$('#mix').value;
    renderList(pickSubset(window._smc2024||problems, n, mix));
  });
})();
</script>

</body>
</html>
